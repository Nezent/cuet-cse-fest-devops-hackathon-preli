name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend
        run: docker build -t backend:test -f backend/Dockerfile backend/

      - name: Build gateway
        run: docker build -t gateway:test -f gateway/Dockerfile gateway/

  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p deploy
          # Copy docker compose files
          cp -r docker deploy/
          # Copy service directories with their Dockerfiles
          cp -r backend deploy/
          cp -r gateway deploy/
          # Copy Makefile for convenience
          cp Makefile deploy/
          tar -czf deploy.tar.gz deploy/

      - name: Copy files to Azure VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          source: "deploy.tar.gz"
          target: "/home/${{ secrets.USERNAME }}/ecommerce-app"
          strip_components: 0

      - name: Deploy to Azure VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            cd /home/${{ secrets.USERNAME }}/ecommerce-app
            
            # Extract and deploy
            tar -xzf deploy.tar.gz
            cp -r deploy/* .
            
            # Create .env file from GitHub secrets
            cat > .env << EOF
            MONGO_INITDB_ROOT_USERNAME=${{ secrets.MONGO_INITDB_ROOT_USERNAME }}
            MONGO_INITDB_ROOT_PASSWORD=${{ secrets.MONGO_INITDB_ROOT_PASSWORD }}
            MONGO_URI=${{ secrets.MONGO_URI }}
            MONGO_DATABASE=${{ secrets.MONGO_DATABASE }}
            BACKEND_PORT=${{ secrets.BACKEND_PORT }}
            GATEWAY_PORT=${{ secrets.GATEWAY_PORT }}
            NODE_ENV=${{ secrets.NODE_ENV }}
            EOF
            
            # Stop and clean existing containers
            sudo docker compose -f docker/compose.production.yaml down 2>/dev/null || true
            sudo docker image prune -af >/dev/null 2>&1 || true
            
            # Start services
            echo "üöÄ Deploying services..."
            sudo docker compose -f docker/compose.production.yaml up -d --build
            
            # Wait and verify
            sleep 20
            echo "üìä Service status:"
            sudo docker compose -f docker/compose.production.yaml ps

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            cd /home/${{ secrets.USERNAME }}/ecommerce-app
            # Test gateway endpoint (port 5921 as specified in architecture)
            curl -f http://localhost:5921/health && echo "‚úÖ Deployment successful!" || echo "‚ùå Health check failed"
            sudo docker compose -f docker/compose.production.yaml ps
